#! /bin/bash

if [ -f ~/.factory_env ]; then
    export $(grep -v '^#' ~/.factory_env | xargs)
fi

CONTAINER_NAME=${FACTORY_MAIN_CONTAINER_NAME:-isaac-sim-ws}

stop_container() {
	# ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
	if ! docker ps -a --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    	echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    	exit 1
	fi

	# ã‚³ãƒ³ãƒ†ãƒŠãŒå®Ÿè¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯
	if docker ps --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    		echo "ğŸ›‘ ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."
    		docker stop ${CONTAINER_NAME}

    		if [ $? -eq 0 ]; then
        		echo "âœ… ã‚³ãƒ³ãƒ†ãƒŠãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚"
    		else
        		echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        		exit 1
    		fi
	fi
}

delete_container() {
	# ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¦å®Œå…¨åˆæœŸåŒ–
	echo "ğŸ—‘ï¸  ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™..."
	docker rm ${CONTAINER_NAME}

	if [ $? -eq 0 ]; then
    		echo "âœ… ã‚³ãƒ³ãƒ†ãƒŠãŒå‰Šé™¤ã•ã‚Œã€å®Œå…¨ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚"
    		echo ""
    		echo "ğŸš€ æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
    		echo "   ./run_isaac_sim_docker.sh"
	else
    		echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    		exit 1
	fi
}

docker_connect () {
	docker exec -it ${CONTAINER_NAME} /bin/bash
}

run_world () {
	docker exec -it ${CONTAINER_NAME} sh -c "source ~/.bashrc ; /isaac-sim/python.sh /world/factory_world1/factory.py"
}


case "$1" in
  "run")
	$FACTORY_BASE/at_factory/run_isaac_sim_docker.sh ;;
  "start")
	docker start ${CONTAINER_NAME}
	docker_connect
	;;
  "con")
        docker_connect ;;
  "stop")
	stop_container ;;
  "rm")
	delete_container ;;
  "world")
        run_world ;;
  "help"|"?"|"")
	echo "at_factory docker control command"
	echo "fct run: run at_factory docker (required at init time only)"
	echo "fct start: start existing at_factory docker (isaac-sim-ws)"
	echo "fct con: connect to the at_factory docker"
	echo "fct stop: stopping the running at_factory docker"
	echo "fct rm: rm the running at_factory docker"
esac
