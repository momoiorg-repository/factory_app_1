#! /bin/bash

if [ -f ${FACTORY_BASE}/.factory/.env ]; then
    export $(grep -v '^#' ${FACTORY_BASE}/.factory_env | xargs)
fi

CONTAINER_NAME=${FACTORY_APP_CONTAINER_NAME:-factory_app}

stop_container() {
	# ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
	if ! docker ps -a --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    	echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    	exit 1
	fi

	# ã‚³ãƒ³ãƒ†ãƒŠãŒå®Ÿè¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯
	if docker ps --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    		echo "ğŸ›‘ ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."
    		docker stop ${CONTAINER_NAME}

    		if [ $? -eq 0 ]; then
        		echo "âœ… ã‚³ãƒ³ãƒ†ãƒŠãŒåœæ­¢ã•ã‚Œã¾ã—ãŸã€‚"
    		else
        		echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        		exit 1
    		fi
	fi
}

delete_container() {
	# ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¦å®Œå…¨åˆæœŸåŒ–
	echo "ğŸ—‘ï¸  ã‚³ãƒ³ãƒ†ãƒŠ ${CONTAINER_NAME} ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™..."
	docker rm ${CONTAINER_NAME}

	if [ $? -eq 0 ]; then
    		echo "âœ… ã‚³ãƒ³ãƒ†ãƒŠãŒå‰Šé™¤ã•ã‚Œã€å®Œå…¨ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚"
    		echo ""
    		echo "ğŸš€ æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
    		echo "   act run"
	else
    		echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    		exit 1
	fi
}

build_docker_image(){
    if docker images | grep -q "factory_app.*latest"; then
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ 'factory_app:latest' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
        read -p "å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "æ—¢å­˜ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™..."
            return
        fi
    fi

    echo "Building Docker image..."
    cd $FACTORY_BASE/factory_app_1
    docker build -t factory_app:latest -f ./build/Dockerfile .

    if docker images | grep -q "factory_app.*latest"; then
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ 'factory_app:latest' ã¯æ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚"
    else
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ 'factory_app:latest' ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        exit 1
    fi
}

run_docker_container(){

    if docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
        echo "Dockerã‚³ãƒ³ãƒ†ãƒŠ '${CONTAINER_NAME}' ã¯æ—¢ã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
        return
    fi

    echo "Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™..."
    docker run -d \
        --name ${CONTAINER_NAME} \
        --network host \
        --ipc host \
        -e DISPLAY=${DISPLAY} \
        -e NVIDIA_VISIBLE_DEVICES=all \
        -e NVIDIA_DRIVER_CAPABILITIES=all \
        -e ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-31} \
        -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
        -v $HOME/.Xauthority:/root/.Xauthority:ro \
        -v $FACTORY_BASE/factory_app_1/pytwb_ws:/root/pytwb_ws:rw \
        -v $FACTORY_BASE/config:/root/config:rw \
        --gpus all \
        --tty \
        factory_app:latest \
        tail -f /dev/null
}

connect_to_container(){
  if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
  fi

  if ! docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Names}}" | grep -q "^${CONTAINER_NAME:-factory_app}$"; then
    echo "Dockerã‚³ãƒ³ãƒ†ãƒŠ '${CONTAINER_NAME}' ã¯èµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚"
    echo "ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™..."
    docker start ${CONTAINER_NAME}
  fi

  echo "Dockerã‚³ãƒ³ãƒ†ãƒŠ '${CONTAINER_NAME}' ã«æ¥ç¶šã—ã¾ã™..."
  docker exec -it ${CONTAINER_NAME} bash
}

comment(){
    echo "================================"
    echo "åˆã‚ã¦å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
    echo "$ cd pytwb_ws"
    echo "$ pytwb"
    echo "> create cm1"
    echo "> Y"
    echo "exit"
    echo "================================"
    echo "Actorã‚„BTã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
    echo "$ actor"
    echo "================================"
}

case "$1" in
  "build")
  	build_docker_image ;;
  "run")
	run_docker_container ;;
  "start")
	docker start ${CONTAINER_NAME}
        connect_to_container
	;;
  "con")
        connect_to_container ;;
  "stop")
	stop_container ;;
  "rm")
	delete_container ;;
  "help"|"?"|"")
	echo "factory app docker control command"
	echo "act build: build factory app docker image"
	echo "act run: run factory_app docker (required at init time only)"
	echo "act start: start existing factory_app docker (factory_app)"
	echo "act con: connect to the factory_app docker"
	echo "act stop: stopping the running factory_app docker"
	echo "act rm: rm the running factory_app docker"
esac
